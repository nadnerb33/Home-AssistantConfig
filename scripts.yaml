
watch_kodi:
  alias: Watch Kodi
  sequence:
  - service: script.turn_on
    entity_id: script.start_living_room
  - service: switch.turn_on
    entity_id: switch.living_room_power
  - service: hdmi_cec.power_on
    data:
      device: 0.0.0.0
  - data:
      source: Kodi
    service: script.wake_rxv481d
  - service: light.turn_on
    data:
      entity_id: light.hyperion
      effect: HDMI

watch_tv:
  alias: Watch TV
  sequence:
  - service: switch.turn_on
    entity_id: switch.freesat
  - service: script.turn_on
    entity_id: script.start_living_room
  - service: switch.turn_on
    entity_id: switch.living_room_power
  - service: light.turn_on
    data:
      entity_id: light.hyperion
      rgb_color: [0,167,247]
      brightness: 150
  - data:
      source: Freesat
    service: script.wake_rxv481d
  - service: hdmi_cec.power_on
    data:
      device: 0.0.0.0


play_ps4:
  alias: Play PS4
  sequence:
  - service: script.turn_on
    entity_id: script.start_living_room
  - service: switch.turn_on
    entity_id: switch.living_room_power
  - service: shell_command.switch_on_ps4 #add condition so this only runs if PS4 is off
  - service: hdmi_cec.power_on
    data:
      device: 0.0.0.0
  - service: light.turn_on
    data:
      entity_id: light.hyperion
      rgb_color: [0,167,247]
      brightness: 150
  - data:
      source: PS4
    service: script.wake_rxv481d

play_vinyl:
  alias: Play vinyl
  sequence:
  - service: switch.turn_on
    entity_id: switch.living_room_power
  - data:
      source: Vinyl
    service: script.wake_rxv481d


update_kodi_library:
  alias: Update Kodi Library
  sequence:
  - alias: Call Kodi update
    service: media_player.kodi_call_method
    data:
      entity_id: media_player.kodi
      method: VideoLibrary.Scan

start_living_room:
  #this only runs if living room power isnt on yet, it just flashes the LEDs as this is the first time it starts.
  alias: Start Living Room
  sequence:
  - service: light.turn_on
    entity_id: light.living_room_lamp
  - condition: state
    entity_id: switch.living_room_power
    state: 'off'  
  - service: light.turn_on
    data:
      entity_id: light.hyperion
      effect: Rainbow swirl fast

ps4_start_x:
  alias: PS4 Start X
  sequence:
  - service: script.turn_on
    entity_id: script.play_ps4
  - service: shell_command.start_ps4_app
    data_template:
      app_id: >
        {% if   (title == "Netflix")   %}  CUSA00127
        {% elif (title == "YouTube")   %}  CUSA01116
        {% elif (title == "Yakuza 0")  %}  CUSA05133
        {% elif (title == "Inside")    %}  CUSA02754
        {% elif (title == "In Side")   %}  CUSA02754
        {% elif (title == "Shenmue")   %}  CUSA08355
        {% elif (title == "Shenmue 2") %}  CUSA08356
        {% elif (title == "iPlayer")   %}  CUSA00122
        {% elif (title.lower() == "red dead 2")%}  CUSA08519
        {% elif (title == "Red Dead Redemption 2") %}  CUSA08519

        {% endif %}

yamaha_volume_x:
  alias: Change Yamaha Volume
  sequence:
  - service: media_player.volume_set
    entity_id: media_player.yamaha_rxv481d
    data_template:
      volume_level: >
        {% if   (vol == "30") %} 0.7
        {% elif (vol == "35") %} 0.65
        {% elif (vol == "40") %} 0.6
        {% elif (vol == "45") %} 0.55
        {% elif (vol == "50") %} 0.5
        {% elif (vol == "55") %} 0.45
        {% endif %}

yamaha_source_x:
  alias: Switch Yamaha Source
  sequence:
  - service: media_player.select_source
    entity_id: media_player.yamaha_rxv481d
    # we need to account for variations in Google's spelling of the spoken phrases
    data_template:
      source: >
        {% if   (source == "PS 4")          %} PS4
        {% elif (source == "Playstation 4") %} PS4
        {% elif (source == "HDMI 1")        %} HDMI1
        {% elif (source == "HDMI 2")        %} HDMI2
        {% elif (source == "HDMI 3")        %} HDMI3
        {% elif (source == "HDMI 4")        %} HDMI4
        {% elif (source == "kodi")          %} HDMI3
        {% elif (source == "FREESAT")       %} HDMI2
        {% elif (source == "freezer")       %} HDMI2
        {% elif (source == "AV 3")          %} AV3
        {% elif (source == "AV free")       %} AV3
        {% elif (source == "rhino")         %} AV3
        {% elif (source == "vinyl")         %} AV3
        {% else %} {{source}}
        {% endif %}

yamaha_mute:
  alias: Mute Yamaha
  sequence:
  - service: media_player.volume_mute
    entity_id: media_player.yamaha_rxv481d
    data_template:
      is_volume_muted: >
        {% if (state_attr('media_player.yamaha_rxv481d' , 'is_volume_muted') == false)   %} true
        {% else  %} false
        {% endif %}

freesat_channel_x:
  alias: Switch Freesat Channel
  sequence:
    # we need to account for variations in Google's spelling of the spoken phrases
  - service: shell_command.switch_freesat_channel
    data_template:
      sequence: >
        {% if   (channel.upper() == "BBC 1") %} 1 0 6
        {% elif (channel.upper() == "BBC 2") %} 1 0 2
        {% elif (channel.upper() == "BBC 4") %} 1 0 7
        {% elif (channel.upper() == "CHANNEL 4") %} 1 0 4
        {% elif (channel.upper() == "CHANNEL 5") %} 1 0 5
        {% elif (channel.upper() == "ITV") %} 1 1 1
        {% elif (channel.upper() == "NHK") %} 2 0 9
        {% elif (channel.upper() == "BBC NEWS") %} 2 0 0
        {% elif (channel.upper() == "SKY NEWS") %} 20 2
        {% elif (channel.upper() == "PAUSE") %} Pause
        {% elif (channel.upper() == "PLAY") %} Play
        {% elif (channel.upper() == "RESUME") %} Play
        {% elif (channel.upper() == "RECORD") %} Record
        {% elif (channel.upper() == "MUTE") %} Mute
        {% elif (channel.upper() == "UNMUTE") %} Mute
        {% elif (channel.upper() == "INFO") %} i i ; sleep 8; irsend -d /var/run/lirc/lircd-lirc0 SEND_ONCE freesat Exit
        {% else %} {{channel|title}}
        {% endif %}


shutdown_living_room:
  alias: Shutdown Living Room
  sequence:
  - service: media_player.play_media
    data_template:
      entity_id: media_player.google_home_living_room
      media_content_id: https://nadnerb.duckdns.org:8123/local/shutdown.mp3
      media_content_type: audio/mp4
  - service: light.turn_on
    data:
      entity_id: light.hyperion
      effect: Rainbow swirl slow
  - service: media_player.turn_off
    entity_id: media_player.tv
  # - service: switch.turn_off
  #   entity_id: switch.freesat
  - service: shell_command.switch_off_ps4
  - service: media_player.turn_off
    entity_id: media_player.yamaha_rxv481d
  - delay: 00:00:10
  - service: light.turn_off
    data:
      entity_id: light.hyperion
  #- service: shell_command.stop_hyperiond
  # - service: shell_command.stop_kodi 
  - service: switch.turn_off
    entity_id: switch.living_room_power
  - service: light.turn_off
    entity_id: light.living_room_lamp

# wtf is going on here? Well, these scripts fix some issues with the AVR.
# firstly, the AVR is only accesible to HA if it was on(or in standby) when HA first booted.
# so for this to work, each time HA is restarted the AVR should have power (and network standby be enabled)
# When power is switched on for the AVR then you have to wait in a loop for the AVR network to come up before you
# can access it, set source etc.
# the 3 scripts do this

# No1. this is called by other scripts. e.g "watch TV", or "play ps4"
# it will load another script which will attempt to turn on AVR
# it will then wait until the AVR then switches back to AV2 (a bug/quirk of ARC) before switching back to the required source
wake_rxv481d:
  alias: Wake Yamaha RXV481D with timeout
  sequence:
  # - data_template:
  #     source: '{{source}}'
  #   service: script.wake_rxv481d_action
  - service: media_player.turn_on
    entity_id: media_player.yamaha_rxv481d
  - service: media_player.select_source
    entity_id: media_player.yamaha_rxv481d
    data_template:
      source: '{{source}}'
  - service: switch.turn_on
    data:
      entity_id: switch.led
  - wait_template: "{{ source != state_attr('media_player.yamaha_rxv481d' , 'source') }}" 
    timeout: 00:00:30
  #set source again
  - service: media_player.select_source
    entity_id: media_player.yamaha_rxv481d
    data_template:
      source: '{{source}}'
  - wait_template: "{{ source != state_attr('media_player.yamaha_rxv481d' , 'source') }}" 
    timeout: 00:00:30
  #set source again
  - service: media_player.select_source
    entity_id: media_player.yamaha_rxv481d
    data_template:
      source: '{{source}}'    
  - service: switch.turn_off
    data:
      entity_id: switch.led

#No2. this is called by script no1.
# if the avr is on, then it will set the source and stop
# if not, it will try, fail and then start another script which will loop back to this one every 6 seconds
# if on a subsequent run through it turns on the AVR then the loop is stopped.
# could get stuck in a loop if it never turns on, could implement a counter and a maximum no of attempts?
wake_rxv481d_action:
  alias: Wake Yamaha RXV481D
  sequence:
  - service: switch.turn_off
    data:
      entity_id: switch.led
  - service: hdmi_cec.power_on
    data:
      device: 2.0.0.0
  - service: media_player.turn_on
    entity_id: media_player.yamaha_rxv481d
  - service: media_player.select_source
    # entity_id: media_player.yamaha_rxv481d
    data_template:
      source: '{{source}}'
  #was the switch on successful? if so quit, if not, continue
  - condition: state
    entity_id: media_player.yamaha_rxv481d
    state: 'off'
  # - service: switch.turn_on
  #   data:
  #     entity_id: switch.led
  - delay: 00:00:03
  - data_template:
      source: '{{source}}'
    service: script.wake_rxv481d_loop

#No3. just waits 2 secs then tries to turn on the AVR again
wake_rxv481d_loop:
  alias: Wake Yamaha RXV481D again
  sequence:
  - service: switch.turn_off
    data:
      entity_id: switch.led
  - delay: 00:00:02
  - service: switch.turn_on
    data:
      entity_id: switch.led
  - data_template:
      source: '{{source}}'
    service: script.wake_rxv481d


broadcast_via_googlehome:
  alias: Broadcast via GoogleHome
  sequence:
    - service: tts.google_say
      data_template:
        entity_id: media_player.google_home_living_room
        message: "{{ what }}"
    - service: tts.google_say
      data_template:
        entity_id: media_player.google_home_dining_room
        message: "{{ what }}"

